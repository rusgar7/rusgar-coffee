<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="sayfaBasligi">POS Sistemi</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Ferah TasarÄ±m ve SIFIR GECÄ°KME AyarlarÄ± */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f0eb; margin: 0; padding: 20px; color: #333; }
        
        button, .masa, .kategori-baslik { 
            touch-action: manipulation; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .header { display: flex; justify-content: space-between; align-items: center; background: #4a3b32; color: #fff; padding: 15px 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .header-sol { display: flex; align-items: center; gap: 12px; }
        .header-sol h1 { margin: 0; font-size: 22px; letter-spacing: 0.5px;}
        #kafeLogo { max-height: 40px; max-width: 120px; border-radius: 8px; display: none; background: #fff; padding: 2px; object-fit: contain;}
        
        .header-sag { display: flex; gap: 10px; align-items: center; }
        .ciro { font-size: 16px; background: #6b584b; padding: 10px 15px; border-radius: 8px; font-weight: bold; }
        
        .btn-ust { color: #fff; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; display: none; transition: 0.1s ease;}
        .btn-zrapor { background: #ff9800; } .btn-ayarlar { background: #607D8B; } .btn-cikis { background: #d32f2f; display: inline-block; } 
        .aktif-personel { font-size: 14px; background: #fff; color: #4a3b32; padding: 5px 10px; border-radius: 15px; font-weight: bold;}

        /* Sekme TasarÄ±mÄ± */
        .ayar-sekmeler { display: flex; gap: 5px; background: #eee; padding: 5px; border-radius: 10px; margin-bottom: 20px; overflow-x: auto; }
        .sekme-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; background: transparent; color: #555; font-size: 14px; white-space: nowrap;}
        .sekme-btn.aktif { background: white; color: #4a3b32; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .sekme-icerik { display: none; }
        .sekme-icerik.aktif { display: block; }

        .masalar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .masa { background: #fff; border-radius: 10px; padding: 20px 10px; text-align: center; cursor: pointer; transition: 0.1s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.08); font-weight: bold; font-size: 16px; position: relative; border: 1px solid #eee; }
        .bos { border-bottom: 5px solid #4CAF50; color: #2e7d32; }
        .dolu { border-bottom: 5px solid #f44336; color: #c62828; }
        .masa.pasif { opacity: 0.5; cursor: not-allowed; } 
        .sure-rozet { position: absolute; top: 5px; right: 5px; background: #ff9800; color: white; font-size: 10px; padding: 3px 5px; border-radius: 10px; font-weight: bold; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 25px; border-radius: 16px; width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; position: relative;}
        .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; color: #4a3b32; display: flex; justify-content: space-between; align-items: center;}
        .btn-kapat-x { background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;}
        
        .rapor-kutu { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
        .form-grup { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;}
        .form-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; min-width: 120px;}
        .yetki-container { display: flex; gap: 10px; align-items: center; background: #fff; padding: 10px; border-radius: 5px; border: 1px solid #ddd; width: 100%; }
        
        .kategori-baslik { font-size: 15px; color: #fff; background: #6b584b; padding: 10px; border-radius: 8px; margin: 10px 0; cursor: pointer; display: flex; justify-content: space-between;}
        .menu-grid { display: none; grid-template-columns: 1fr 1fr; gap: 8px; padding: 5px 0 15px 0; } 
        .btn-menu { background: #e0d4c8; color: #4a3b32; padding: 12px 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .sepet-kutu { background: #e8f5e9; border: 2px solid #4CAF50; border-radius: 8px; padding: 10px; margin-bottom: 15px; display: none; }
        .btn-onayla { background: #4CAF50; color: white; width: 100%; padding: 15px; font-size: 16px; margin-top: 10px; border:none; cursor:pointer; font-weight:bold; border-radius:8px;}
        .adisyon-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #ccc; font-size: 13px; }
        .btn-kucuk { padding: 8px 10px; font-size: 12px; border-radius: 5px; color: white; border: none; cursor: pointer; font-weight: bold;}
        .toplam-tutar { font-size: 18px; font-weight: bold; text-align: right; margin-bottom: 15px; color: #d32f2f; }
        .aksiyon-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 20px;}
        .btn-ana { flex: 1; padding: 12px; color: white; min-width: 100px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;}
        .bg-kapat { background: #d32f2f; } .bg-tasi { background: #ff9800; } .bg-geri { background: #9e9e9e; } .bg-ekle { background: #4CAF50; }
        .sortable-satir { display: flex; justify-content: space-between; background: #fff; padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; border-radius: 6px; align-items: center; font-size: 14px;}
        .drag-handle { cursor: grab; padding: 0 10px; font-size: 16px; color: #888; }
        .rapor-sekme-alani { display: flex; gap: 5px; margin-bottom: 15px; background: #eee; padding: 5px; border-radius: 8px; overflow-x: auto;}
        .sekme-btn-z { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; background: transparent; color: #555; white-space: nowrap;}
        .sekme-btn-z.aktif { background: #ff9800; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .yetki-grup { display: flex; flex-wrap: wrap; gap: 15px; background: #fff; padding: 15px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; font-size: 13px; font-weight: bold; color: #4a3b32;}
        .yetki-grup label { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        #loginEkrani .modal-content { text-align: center; width: 350px; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn-giris { width: 100%; background: #4CAF50; color: white; padding: 15px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.1s ease;}
    </style>
</head>
<body>

    <div id="loadingEkrani" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; font-size:20px; font-weight:bold; color:#4a3b32; flex-direction: column; gap: 15px;">
        <div style="font-size: 40px;">â˜ï¸</div><div>Bulut VeritabanÄ±na BaÄŸlanÄ±lÄ±yor...</div>
    </div>

    <div class="modal" id="loginEkrani">
        <div class="modal-content">
            <h2 style="color: #4a3b32;" id="loginIsletmeAdi">POS Sistemi</h2>
            <p style="color: #666; font-size: 14px;">(VarsayÄ±lan KullanÄ±cÄ±: Admin | Åifre: 0000)</p>
            <select id="loginKullanici" class="login-input"></select>
            <input type="password" id="loginSifre" class="login-input" placeholder="Åifrenizi Girin">
            <button class="btn-giris" onclick="sistemeGir()">GiriÅŸ Yap</button>
        </div>
    </div>

    <div class="header">
        <div class="header-sol">
            <img id="kafeLogo" src="" alt="Logo">
            <h1 id="headerIsletmeAdi">POS Sistemi</h1>
        </div>
        <div class="header-sag">
            <div class="aktif-personel" id="aktifPersonelLabel">Bekleniyor</div>
            <button class="btn-ust btn-ayarlar" id="btnAyarlar" onclick="ayarlarEkraniAc()">âš™ï¸ YÃ¶netim</button>
            <button class="btn-ust btn-zrapor" id="btnZRaporu" onclick="zRaporuAc()">ğŸ“Š Z Raporu</button>
            <div class="ciro" id="kasaTepesi">Kasa: 0 TL</div>
            <button class="btn-ust btn-cikis" onclick="sistemdenCik()">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
    </div>

    <div class="masalar-grid" id="masalarContainer"></div>

    <div class="modal" id="ayarlarEkrani">
        <div class="modal-content">
            <div class="modal-header">âš™ï¸ YÃ¶netim Paneli <button class="btn-kapat-x" onclick="ayarlarKapat()">X</button></div>
            
            <div class="ayar-sekmeler">
                <button class="sekme-btn aktif" id="btnSekme_isletme" onclick="sekmeGoster('isletme', this)">ğŸ–¼ï¸ Ä°ÅŸletme</button>
                <button class="sekme-btn" id="btnSekme_personel" onclick="sekmeGoster('personel', this)">ğŸ‘¥ Personel</button>
                <button class="sekme-btn" id="btnSekme_masa" onclick="sekmeGoster('masa', this)">ğŸª‘ Masalar</button>
                <button class="sekme-btn" id="btnSekme_menu" onclick="sekmeGoster('menu', this)">ğŸ” MenÃ¼</button>
            </div>

            <div id="sekme_isletme" class="sekme-icerik aktif">
                <div class="rapor-kutu">
                    <div class="rapor-baslik">Ä°ÅŸletme AdÄ±</div>
                    <div class="form-grup"><input type="text" id="ayarIsletmeAdi" class="form-input" placeholder="Ä°ÅŸletme AdÄ±"><button class="btn-ana bg-ekle" style="flex:0.5; padding:10px;" onclick="isletmeAdiKaydet()">Kaydet</button></div>
                    <div class="rapor-baslik" style="margin-top:10px;">Logo AyarlarÄ±</div>
                    <p style="font-size:12px; color:#666; margin-top:0;">*Sistemin yavaÅŸlamamasÄ± iÃ§in kÃ¼Ã§Ã¼k boyutlu resimler yÃ¼kleyin.</p>
                    <div class="form-grup"><input type="file" id="logoUpload" class="form-input" accept="image/*"><button class="btn-ana bg-ekle" style="flex:0.5; padding:10px;" onclick="logoyuYukle()">YÃ¼kle</button> <button class="btn-ana bg-kapat" style="flex:0.5; padding:10px;" onclick="logoyuKaldir()">Sil</button></div>
                </div>
            </div>

            <div id="sekme_personel" class="sekme-icerik">
                <div class="rapor-kutu">
                    <div class="rapor-baslik">Yeni Garson Ekle</div>
                    <div class="form-grup">
                        <input type="text" id="yeniPersIsim" class="form-input" placeholder="Personel AdÄ±">
                        <input type="text" id="yeniPersSifre" class="form-input" placeholder="Åifre (Min 4)">
                    </div>
                    <div class="yetki-grup">
                        <label><input type="checkbox" id="y_odeme" checked> ğŸ’° Ã–deme Alabilir</label>
                        <label><input type="checkbox" id="y_iptal"> âŒ Ä°ptal Yapabilir</label>
                        <label><input type="checkbox" id="y_zrapor"> ğŸ“Š Z Raporu GÃ¶rebilir</label>
                    </div>
                    <button class="btn-ana bg-ekle" style="width: 100%;" onclick="personelEkle()">+ Garson Ekle</button>
                </div>
                <div class="rapor-kutu">
                    <div class="rapor-baslik">Mevcut Personeller</div>
                    <div id="personelListesi"></div>
                </div>
            </div>

            <div id="sekme_masa" class="sekme-icerik">
                <div class="rapor-kutu">
                    <div class="rapor-baslik">ğŸª‘ Masalar (SÄ±ralamak iÃ§in â˜° simgesinden sÃ¼rÃ¼kleyin)</div>
                    <div class="form-grup"><input type="text" id="yeniMasaIsimAyar" class="form-input" placeholder="Ã–rn: BahÃ§e 1"><button class="btn-ana bg-ekle" style="flex:0.5; padding:10px;" onclick="ayarlarMasaEkle()">Ekle</button></div>
                    <div style="max-height: 250px; overflow-y: auto;" id="ayarlarMasaListesi"></div>
                </div>
            </div>

            <div id="sekme_menu" class="sekme-icerik">
                <div class="rapor-kutu">
                    <div class="rapor-baslik">ğŸ“‹ MenÃ¼ Kategori Ekle</div>
                    <div class="form-grup"><input type="text" id="yeniKategoriIsim" class="form-input" placeholder="Ã–rn: TatlÄ±lar"><button class="btn-ana bg-ekle" style="flex:0.5; padding:10px;" onclick="ayarlarKategoriEkle()">Ekle</button></div>
                </div>
                <div class="rapor-kutu">
                    <div class="rapor-baslik">ğŸ” MenÃ¼ YÃ¶netimi</div>
                    <div id="ayarlarMenuListesi"></div>
                </div>
            </div>

            <button class="btn-ana bg-geri" style="width:100%" onclick="ayarlarKapat()">AyarlarÄ± Kapat</button>
        </div>
    </div>

    <div class="modal" id="personelDuzenleEkrani" style="z-index: 1001;">
        <div class="modal-content" style="width: 450px;">
            <div class="modal-header">âœï¸ Personel DÃ¼zenle <button class="btn-kapat-x" onclick="document.getElementById('personelDuzenleEkrani').style.display='none'">X</button></div>
            <div id="duzenleGuvenlikAdimi">
                <div class="rapor-kutu" style="border-color: #f44336; background: #ffebee;">
                    <div class="rapor-baslik" style="color: #d32f2f;">GÃ¼venlik OnayÄ±</div>
                    <p style="font-size: 13px; margin-top:0;">Bu iÅŸlem iÃ§in Admin ÅŸifresi gereklidir.</p>
                    <input type="password" id="duzenleAdminSifre" class="form-input" style="width: 90%; margin-bottom: 15px;" placeholder="Admin Åifrenizi Girin">
                    <button class="btn-ana bg-tasi" style="width: 100%;" onclick="duzenleSifreKontrol()">Kilidi AÃ§</button>
                </div>
            </div>
            <div id="duzenleFormAdimi" style="display: none;">
                <div class="rapor-kutu">
                    <div class="rapor-baslik">Bilgileri GÃ¼ncelle</div>
                    <label class="form-label">KullanÄ±cÄ± AdÄ±:</label><input type="text" id="duzenleIsim" class="form-input" style="width: 90%; margin-bottom: 10px;">
                    <label class="form-label">Åifre (Min 4 hane):</label><input type="text" id="duzenleSifre" class="form-input" style="width: 90%; margin-bottom: 15px;">
                    <label class="form-label">Yetkiler:</label>
                    <div class="yetki-grup">
                        <label><input type="checkbox" id="d_odeme"> ğŸ’° Ã–deme Alabilir</label>
                        <label><input type="checkbox" id="d_iptal"> âŒ Ä°ptal Yapabilir</label>
                        <label><input type="checkbox" id="d_zrapor"> ğŸ“Š Z Raporu GÃ¶rebilir</label>
                    </div>
                    <div style="display: flex; gap: 10px;"><button class="btn-ana bg-geri" onclick="document.getElementById('personelDuzenleEkrani').style.display='none'">Ä°ptal</button><button class="btn-ana bg-ekle" onclick="duzenleKaydet()">Kaydet</button></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="zRaporuEkrani">
        <div class="modal-content">
            <div class="modal-header">ğŸ“Š Z Raporu (Analiz) <button class="btn-kapat-x" onclick="document.getElementById('zRaporuEkrani').style.display='none'">X</button></div>
            
            <div class="rapor-sekme-alani">
                <button class="sekme-btn sekme-btn-z aktif" id="sekme_gunluk" onclick="zRaporuCiz('gunluk')">BugÃ¼n</button>
                <button class="sekme-btn sekme-btn-z" id="sekme_gecmis" onclick="zRaporuCiz('gecmis')">GeÃ§miÅŸ GÃ¼nler</button>
                <button class="sekme-btn sekme-btn-z" id="sekme_haftalik" onclick="zRaporuCiz('haftalik')">Bu Hafta</button>
                <button class="sekme-btn sekme-btn-z" id="sekme_aylik" onclick="zRaporuCiz('aylik')">Bu Ay</button>
            </div>

            <div id="gecmisTarihSecici" style="display:none; margin-bottom: 15px; text-align: center; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ccc;">
                <label style="font-weight:bold; margin-right:10px;">AradÄ±ÄŸÄ±nÄ±z Tarihi SeÃ§in:</label>
                <input type="date" id="gecmisTarih" class="form-input" style="width: 200px; display: inline-block; cursor:pointer;" onchange="gecmisRaporGetir()">
            </div>

            <div id="zRaporuIcerikAlani"></div>
            <button class="btn-ana bg-geri" style="width:100%; margin-top: 15px;" onclick="document.getElementById('zRaporuEkrani').style.display='none'">Kapat</button>
        </div>
    </div>

    <div class="modal" id="siparisEkrani">
        <div class="modal-content">
            <div id="anaPanel">
                <div class="modal-header">
                    <span id="aktifMasaBaslik">Masa X</span>
                    <div style="display:flex; align-items:center; gap:15px;"><span id="masaGuncelTutar" style="color:#d32f2f; font-weight:bold;">0 TL</span><button class="btn-kapat-x" onclick="modaliKapat()">X</button></div>
                </div>
                <div class="sepet-kutu" id="sepetKutu"><div style="color: #2e7d32; font-weight: bold; margin-bottom: 5px;">ğŸ›’ Bekleyen SipariÅŸler</div><div id="bekleyenListesi"></div><button class="btn-onayla" onclick="siparisleriOnayla()">âœ… SipariÅŸleri Onayla</button></div>
                <div id="dinamikMenuContainer"></div>
                <div style="margin-top: 15px; font-weight:bold; color:#d32f2f; border-bottom:1px solid #ccc; padding-bottom:5px;">OnaylanmÄ±ÅŸ Adisyon</div>
                <div class="adisyon" id="adisyonListesi"></div>
                <div class="toplam-tutar">Kalan: <span id="masaToplam">0</span> TL</div>
                <div class="aksiyon-grid" id="standartAksiyonlar">
                    <button class="btn-ana bg-kapat" id="btnOdemeAna" onclick="hesapKapatMenuAc()">ğŸ’° HesabÄ± Kapat / Ã–deme</button>
                    <button class="btn-ana bg-tasi" onclick="masaTasimaEkraniAc()">ğŸ”„ MasayÄ± TaÅŸÄ±</button>
                    <button class="btn-ana bg-geri" onclick="modaliKapat()">ğŸšª Masadan Ã‡Ä±k</button>
                </div>
                <div id="gelismisOdemeSecenekleri" style="display: none; flex-direction: column; gap: 10px; background: #fff3e0; padding: 15px; border-radius: 8px; border: 1px solid #ffb74d; margin-top:15px;">
                    <div style="font-weight:bold; color:#d32f2f; text-align:center;">Hesap NasÄ±l KapatÄ±lÄ±yor?</div>
                    <div style="display:flex; gap:10px;" id="odemeTuruSatiri"></div>
                    <div style="display:flex; gap:10px;" id="iptalSatiri"></div>
                </div>
            </div>
            <div id="tasimaPaneli" style="display: none;">
                <div class="modal-header"><span>Hangi Masaya TaÅŸÄ±nsÄ±n?</span><button class="btn-kapat-x" onclick="masaTasimaIptal()">X</button></div>
                <div class="masalar-grid" id="tasimaGridContainer" style="max-height: 300px; overflow-y: auto;"></div>
                <button class="btn-ana bg-geri" style="width: 100%; margin-top: 15px;" onclick="masaTasimaIptal()">Ä°ptal Et</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. FÄ°REBASE BAÄLANTI AYARLARI
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDOotmbrUb8BfSkZoNbc5yRqiWaPQmv5eM",
            authDomain: "rusgar-coffee.firebaseapp.com",
            databaseURL: "https://rusgar-coffee-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "rusgar-coffee",
            storageBucket: "rusgar-coffee.firebasestorage.app",
            messagingSenderId: "355204353352",
            appId: "1:355204353352:web:c30f4d149e6f91f8d1777d"
        };
        firebase.initializeApp(firebaseConfig);
        const cloudDB = firebase.database();

        // ==========================================
        // ZAMAN (TARÄ°H) HESAPLAMA (Tarih SeÃ§ici ile Uyumlu)
        // ==========================================
        function getGun() { 
            const d = new Date(); 
            const m = String(d.getMonth()+1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${d.getFullYear()}-${m}-${day}`; // YYYY-MM-DD FormatÄ±
        }
        function getAy() { const d = new Date(); const m = String(d.getMonth()+1).padStart(2, '0'); return `${d.getFullYear()}-${m}`; }
        function getHafta() { let d = new Date(); d.setUTCDate(d.getUTCDate() + 4 - (d.getDay()||7)); let yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return d.getUTCFullYear() + '-W' + Math.ceil((((d-yearStart)/86400000)+1)/7); }

        // ==========================================
        // 2. GLOBAL DEÄÄ°ÅKENLER VE BULUT
        // ==========================================
        let db = null; let isSystemReady = false; 
        let aktifPersonel = null; let aktifRol = null; let aktifYetkiler = {};
        let aktifMasaId = null; let bekleyenSiparisler = [];
        let sortableInstances = []; let duzenlenecekPersonel = null; 

        // VeritabanÄ±nÄ± v22 olarak gÃ¼ncelledik (GeÃ§miÅŸ gÃ¼nler iÃ§in)
        cloudDB.ref('rusgarDB_Cloud_v22').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                db = data;
                if (!db.masalar) db.masalar = [];
                db.masalar.forEach(m => { if(!m.siparisler) m.siparisler = []; });
                if (!db.menu) db.menu = [];
                db.menu.forEach(k => { if(!k.urunler) k.urunler = []; });
                if (!db.kullanicilar) db.kullanicilar = { 'Admin': { sifre: '0000', rol: 'admin', yetki: {odeme: true, iptal: true, zrapor: true} } };
                if (!db.gecmisCiro) db.gecmisCiro = {}; // Tarihsel ArÅŸiv
            } else {
                db = {
                    isletmeAdi: 'POS Sistemi', logo: null,
                    kullanicilar: { 'Admin': { sifre: '0000', rol: 'admin', yetki: {odeme: true, iptal: true, zrapor: true} } },
                    masalar: [], 
                    menu: [ { kategori: 'â˜• SÄ±cak Ä°Ã§ecekler', urunler: [ {ad: 'Ã‡ay', fiyat: 25}, {ad: 'Fincan Ã‡ay', fiyat: 40}, {ad: 'TÃ¼rk Kahvesi', fiyat: 50}, {ad: 'Filtre Kahve', fiyat: 65}, {ad: 'Latte', fiyat: 85} ] } ],
                    ciro: {
                        gunluk: { nakit: 0, kart: 0, iptal: 0, persCiro: {}, persIptal: {} },
                        haftalik: { nakit: 0, kart: 0, iptal: 0, persCiro: {}, persIptal: {} },
                        aylik: { nakit: 0, kart: 0, iptal: 0, persCiro: {}, persIptal: {} },
                        tarihler: { gun: getGun(), hafta: getHafta(), ay: getAy() }
                    },
                    gecmisCiro: {}
                };
                for (let i = 1; i <= 30; i++) db.masalar.push({ id: Date.now() + i, isim: `Masa ${i}`, durum: 'bos', siparisler: [], toplam: 0, acilisZamani: null });
                veriyiKaydet(); 
            }

            ciroZamanKontrolu();

            if (!isSystemReady) {
                isSystemReady = true; document.getElementById('loadingEkrani').style.display = 'none'; document.getElementById('loginEkrani').style.display = 'flex';
                isletmeBilgisiGuncelle(); loginEkraniniHazirla();
            }

            if(aktifPersonel) {
                ekraniguncelle();
                if (document.getElementById('siparisEkrani').style.display === 'flex' && aktifMasaId) {
                    const guncelMasa = getMasa(aktifMasaId);
                    if(guncelMasa) { document.getElementById('aktifMasaBaslik').innerText = guncelMasa.isim; adisyonuCiz(); }
                }
            }
        });

        function veriyiKaydet() { cloudDB.ref('rusgarDB_Cloud_v22').set(db); }

        // ==========================================
        // CÄ°RO ZAMANLAYICISI (GEÃ‡MÄ°ÅE KAYIT EKLENDÄ°)
        // ==========================================
        function ciroZamanKontrolu() {
            if(!db.ciro) return; let degisti = false;
            const suAnGun = getGun(); const suAnHafta = getHafta(); const suAnAy = getAy();

            // GÃ¼n deÄŸiÅŸtiyse bugÃ¼nÃ¼ geÃ§miÅŸe kaydet, sonra sÄ±fÄ±rla
            if(db.ciro.tarihler.gun !== suAnGun) {
                if(!db.gecmisCiro) db.gecmisCiro = {};
                // DÃ¼nkÃ¼ veriyi tarihe gÃ¶re arÅŸivle
                db.gecmisCiro[db.ciro.tarihler.gun] = JSON.parse(JSON.stringify(db.ciro.gunluk)); 
                
                db.ciro.gunluk = { nakit: 0, kart: 0, iptal: 0, persCiro: {}, persIptal: {} };
                db.ciro.tarihler.gun = suAnGun; degisti = true;
            }
            if(db.ciro.tarihler.hafta !== suAnHafta) {
                db.ciro.haftalik = { nakit: 0, kart: 0, iptal: 0, persCiro: {}, persIptal: {} };
                db.ciro.tarihler.hafta = suAnHafta; degisti = true;
            }
            if(db.ciro.tarihler.ay !== suAnAy) {
                db.ciro.aylik = { nakit: 0, kart: 0, iptal: 0, persCiro: {}, persIptal: {} };
                db.ciro.tarihler.ay = suAnAy; degisti = true;
            }
            if(degisti) veriyiKaydet();
        }

        function genelCiroEkle(tur, tutar) {
            ciroZamanKontrolu();
            ['gunluk', 'haftalik', 'aylik'].forEach(d => { db.ciro[d][tur] += tutar; });
        }
        function persCiroEkle(isim, tutar) {
            ciroZamanKontrolu();
            ['gunluk', 'haftalik', 'aylik'].forEach(d => {
                if(!db.ciro[d].persCiro) db.ciro[d].persCiro = {};
                if(!db.ciro[d].persCiro[isim]) db.ciro[d].persCiro[isim] = 0;
                db.ciro[d].persCiro[isim] += tutar;
            });
        }
        function persIptalEkle(isim, tutar) {
            ciroZamanKontrolu();
            ['gunluk', 'haftalik', 'aylik'].forEach(d => {
                if(!db.ciro[d].persIptal) db.ciro[d].persIptal = {};
                if(!db.ciro[d].persIptal[isim]) db.ciro[d].persIptal[isim] = 0;
                db.ciro[d].persIptal[isim] += tutar;
                db.ciro[d].iptal += tutar; 
            });
        }

        // ==========================================
        // UI FONKSÄ°YONLARI 
        // ==========================================
        function sekmeGoster(sekmeId, btn) {
            document.querySelectorAll('.sekme-icerik').forEach(el => el.classList.remove('aktif'));
            document.querySelectorAll('.ayar-sekmeler .sekme-btn').forEach(el => el.classList.remove('aktif'));
            document.getElementById('sekme_' + sekmeId).classList.add('aktif'); btn.classList.add('aktif');
            
            if(sekmeId === 'masa') ayarlarMasaCiz();
            if(sekmeId === 'menu') ayarlarMenuCiz();
            if(sekmeId === 'personel') personelListesiniCiz();
        }

        function isletmeBilgisiGuncelle() {
            const ad = db.isletmeAdi || 'POS Sistemi';
            document.getElementById('headerIsletmeAdi').innerText = ad; document.getElementById('loginIsletmeAdi').innerText = ad;
            document.getElementById('sayfaBasligi').innerText = ad; document.getElementById('ayarIsletmeAdi').value = ad; 
            const img = document.getElementById('kafeLogo');
            if (db.logo) { img.src = db.logo; img.style.display = 'inline-block'; } else { img.src = ''; img.style.display = 'none'; }
        }

        function isletmeAdiKaydet() { const y = document.getElementById('ayarIsletmeAdi').value.trim(); if(y) { db.isletmeAdi = y; veriyiKaydet(); alert("Ä°ÅŸletme adÄ± kaydedildi!"); } }
        function logoyuYukle() { const f = document.getElementById('logoUpload').files[0]; if (f) { const r = new FileReader(); r.onload = function(e) { db.logo = e.target.result; veriyiKaydet(); alert("Logo baÅŸarÄ±yla eklendi!"); }; r.readAsDataURL(f); } }
        function logoyuKaldir() { db.logo = null; veriyiKaydet(); document.getElementById('logoUpload').value = ""; }

        function loginEkraniniHazirla() {
            const select = document.getElementById('loginKullanici'); select.innerHTML = '';
            for (let isim in db.kullanicilar) { select.innerHTML += `<option value="${isim}">${isim}</option>`; }
        }
        function sistemeGir() {
            const k = document.getElementById('loginKullanici').value; const s = document.getElementById('loginSifre').value;
            if (db.kullanicilar[k].sifre === s) {
                aktifPersonel = k; aktifRol = db.kullanicilar[k].rol;
                aktifYetkiler = db.kullanicilar[k].yetki || {odeme: false, iptal: false, zrapor: false};
                if(aktifRol === 'admin') aktifYetkiler = {odeme: true, iptal: true, zrapor: true}; 

                document.getElementById('aktifPersonelLabel').innerText = `ğŸ‘¤ ${k}`;
                document.getElementById('loginEkrani').style.display = 'none'; document.getElementById('loginSifre').value = '';
                
                document.getElementById('btnZRaporu').style.display = aktifYetkiler.zrapor ? 'inline-block' : 'none';
                document.getElementById('btnAyarlar').style.display = aktifRol === 'admin' ? 'inline-block' : 'none';
                ekraniguncelle();
            } else { alert("âŒ HatalÄ± ÅŸifre!"); }
        }
        function sistemdenCik() { if(confirm("Ã‡Ä±kÄ±ÅŸ yapmak istiyor musunuz?")) location.reload(); }

        function ekraniguncelle() {
            const c = document.getElementById('masalarContainer'); c.innerHTML = '';
            let gunlukCiroTutar = 0; if(db.ciro && db.ciro.gunluk) gunlukCiroTutar = db.ciro.gunluk.nakit + db.ciro.gunluk.kart;
            document.getElementById('kasaTepesi').innerText = `Kasa: ${gunlukCiroTutar} TL`;
            
            const suAn = Date.now();
            db.masalar.forEach(m => {
                const div = document.createElement('div'); div.className = `masa ${m.durum}`;
                let icerik = `${m.isim}<br><span style="font-size:14px; font-weight:normal;">${m.toplam > 0 ? m.toplam + ' TL' : 'BoÅŸ'}</span>`;
                if (m.durum === 'dolu' && m.acilisZamani) { icerik += `<div class="sure-rozet">${Math.floor((suAn - m.acilisZamani) / 60000)} dk</div>`; }
                div.innerHTML = icerik; div.onclick = () => modaliAc(m.id); c.appendChild(div);
            });
        }
        setInterval(() => { if(aktifPersonel) ekraniguncelle(); }, 60000);

        function ayarlarEkraniAc() { sekmeGoster('isletme', document.getElementById('btnSekme_isletme')); document.getElementById('ayarlarEkrani').style.display = 'flex'; }
        function ayarlarKapat() { sortableInstances.forEach(s => s.destroy()); sortableInstances = []; document.getElementById('ayarlarEkrani').style.display='none'; ekraniguncelle(); }

        // BUGFIX: Ekleme butonlarÄ± tÄ±klandÄ±ÄŸÄ± an listeyi Ã§izer
        function ayarlarMasaEkle() {
            const isim = document.getElementById('yeniMasaIsimAyar').value.trim();
            if(!isim) return; db.masalar.push({ id: Date.now(), isim: isim, durum: 'bos', siparisler: [], toplam: 0, acilisZamani: null });
            document.getElementById('yeniMasaIsimAyar').value = ''; veriyiKaydet(); ayarlarMasaCiz();
        }
        function ayarlarMasaSil(id) {
            const i = db.masalar.findIndex(m => m.id === id); if(db.masalar[i].toplam > 0) return alert("AÃ§Ä±k hesap var!");
            if(confirm("Silinsin mi?")) { db.masalar.splice(i, 1); veriyiKaydet(); ayarlarMasaCiz(); }
        }
        function ayarlarMasaCiz() {
            const liste = document.getElementById('ayarlarMasaListesi'); liste.innerHTML = '';
            db.masalar.forEach(m => { liste.innerHTML += `<div class="sortable-satir" data-id="${m.id}"><div><span class="drag-handle">â˜°</span> ğŸª‘ <b>${m.isim}</b> ${m.toplam>0 ? '(Dolu)' : ''}</div><button class="btn-kucuk btn-sil" onclick="ayarlarMasaSil(${m.id})">Sil</button></div>`; });
            if(sortableInstances[0]) sortableInstances[0].destroy();
            sortableInstances[0] = new Sortable(liste, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: function (evt) { const moved = db.masalar.splice(evt.oldIndex, 1)[0]; db.masalar.splice(evt.newIndex, 0, moved); veriyiKaydet(); }});
        }

        function ayarlarKategoriEkle() {
            const isim = document.getElementById('yeniKategoriIsim').value.trim();
            if(!isim) return; db.menu.push({ kategori: isim, urunler: [] }); document.getElementById('yeniKategoriIsim').value = ''; veriyiKaydet(); ayarlarMenuCiz();
        }
        function ayarlarKategoriSil(kIdx) { if(confirm("Kategori silinecek!")) { db.menu.splice(kIdx, 1); veriyiKaydet(); ayarlarMenuCiz(); } }
        function ayarlarUrunEkle(kIdx) {
            const ad = document.getElementById(`yUrunAd_${kIdx}`).value.trim(); const fiyat = parseInt(document.getElementById(`yUrunFiyat_${kIdx}`).value);
            if(!ad || isNaN(fiyat)) return; db.menu[kIdx].urunler.push({ ad: ad, fiyat: fiyat }); veriyiKaydet(); ayarlarMenuCiz();
        }
        function ayarlarUrunSil(kIdx, uIdx) { db.menu[kIdx].urunler.splice(uIdx, 1); veriyiKaydet(); ayarlarMenuCiz(); }

        function ayarlarMenuCiz() {
            const liste = document.getElementById('ayarlarMenuListesi'); liste.innerHTML = '';
            db.menu.forEach((kat, kIdx) => {
                let html = `<div class="sortable-kat" style="background:#f1f8e9; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #c5e1a5;"><div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; color:#33691E;"><div><span class="drag-handle">â˜°</span> ğŸ“‹ ${kat.kategori}</div><button class="btn-kucuk btn-sil" onclick="ayarlarKategoriSil(${kIdx})">Sil</button></div><div class="form-grup"><input type="text" id="yUrunAd_${kIdx}" class="form-input" placeholder="Yeni ÃœrÃ¼n"><input type="number" id="yUrunFiyat_${kIdx}" class="form-input" placeholder="TL" style="width:60px; flex:none;"><button class="btn-kucuk bg-ekle" onclick="ayarlarUrunEkle(${kIdx})">Ekle</button></div><div id="urunListe_${kIdx}">`;
                kat.urunler.forEach((urun, uIdx) => { html += `<div class="sortable-satir"><div><span class="drag-handle">â˜°</span> â˜• ${urun.ad} - <b>${urun.fiyat} TL</b></div><button class="btn-kucuk btn-sil" onclick="ayarlarUrunSil(${kIdx}, ${uIdx})">Sil</button></div>`; });
                html += `</div></div>`; liste.innerHTML += html;
            });
            new Sortable(liste, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: function (evt) { const moved = db.menu.splice(evt.oldIndex, 1)[0]; db.menu.splice(evt.newIndex, 0, moved); veriyiKaydet(); ayarlarMenuCiz(); }});
            db.menu.forEach((kat, kIdx) => { new Sortable(document.getElementById(`urunListe_${kIdx}`), { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: function (evt) { const moved = db.menu[kIdx].urunler.splice(evt.oldIndex, 1)[0]; db.menu[kIdx].urunler.splice(evt.newIndex, 0, moved); veriyiKaydet(); ayarlarMenuCiz(); }}); });
        }

        // --- SÄ°PARÄ°Å & POS ---
        function posMenuyuCiz() {
            const container = document.getElementById('dinamikMenuContainer'); container.innerHTML = '';
            db.menu.forEach((kat, index) => {
                const katId = `dinamikKat_${index}`;
                let html = `<div class="kategori-baslik" onclick="kategoriGoster('${katId}')">${kat.kategori} <span>â–¼</span></div><div class="menu-grid" id="${katId}">`;
                kat.urunler.forEach(urun => { html += `<button class="btn-menu" onclick="sepeteEkle('${urun.ad.replace(/['"]/g, "")}', ${urun.fiyat})">${urun.ad} (${urun.fiyat} TL)</button>`; });
                html += `</div>`; container.innerHTML += html;
            });
        }

        function getMasa(id) { return db.masalar.find(m => m.id === id); }

        function modaliAc(id) {
            aktifMasaId = id; bekleyenSiparisler = []; hesapKapatMenuKapat(); 
            document.getElementById('anaPanel').style.display = 'block'; document.getElementById('tasimaPaneli').style.display = 'none';
            document.getElementById('aktifMasaBaslik').innerText = getMasa(id).isim;
            document.getElementById('btnOdemeAna').style.display = aktifYetkiler.odeme ? 'inline-block' : 'none';
            posMenuyuCiz(); document.getElementById('siparisEkrani').style.display = 'flex'; sepetiCiz(); adisyonuCiz();
        }
        function modaliKapat() { if(bekleyenSiparisler.length > 0 && !confirm("Bekleyen sipariÅŸler silinecek. Ã‡Ä±kÄ±lsÄ±n mÄ±?")) return; document.getElementById('siparisEkrani').style.display = 'none'; }
        function kategoriGoster(id) { const k = document.getElementById(id); k.style.display = k.style.display === "grid" ? "none" : "grid"; }
        
        function sepeteEkle(ad, fiyat) { bekleyenSiparisler.push({ urun: ad, fiyat: fiyat }); sepetiCiz(); }
        function sepettenCikar(i) { bekleyenSiparisler.splice(i, 1); sepetiCiz(); }
        function sepetiCiz() {
            const liste = document.getElementById('bekleyenListesi'); liste.innerHTML = '';
            document.getElementById('sepetKutu').style.display = bekleyenSiparisler.length > 0 ? 'block' : 'none';
            bekleyenSiparisler.forEach((s, i) => { liste.innerHTML += `<div class="adisyon-item"><span>ğŸ•’ ${s.urun} - ${s.fiyat} TL</span> <button class="btn-kucuk btn-sil" onclick="sepettenCikar(${i})">Sil</button></div>`; });
        }

        // BUGFIX: SipariÅŸ onayÄ± hatasÄ±zlaÅŸtÄ±rÄ±ldÄ±.
        function siparisleriOnayla() {
            if (bekleyenSiparisler.length === 0) return; let m = getMasa(aktifMasaId);
            if (m.durum === 'bos') { m.durum = 'dolu'; m.acilisZamani = Date.now(); }
            if (!m.siparisler) m.siparisler = [];
            
            bekleyenSiparisler.forEach(s => { 
                m.siparisler.push({ urun: s.urun, fiyat: s.fiyat, odendi: false, garson: aktifPersonel }); 
                m.toplam += s.fiyat; persCiroEkle(aktifPersonel, s.fiyat); 
            });
            bekleyenSiparisler = []; sepetiCiz(); adisyonuCiz(); veriyiKaydet(); 
        }

        function adisyonuCiz() {
            const liste = document.getElementById('adisyonListesi'); liste.innerHTML = '';
            let acik = false; let m = getMasa(aktifMasaId);
            if(m && m.siparisler) {
                m.siparisler.forEach((siparis, i) => {
                    if (!siparis.odendi) {
                        acik = true; const gB = `<span style="font-size:10px; color:#888; display:block;">Ekleyen: ${siparis.garson}</span>`;
                        const iptalBtn = aktifYetkiler.iptal ? `<button class="btn-kucuk btn-sil" onclick="tekliUrunIptal(${i})">âŒ</button>` : '';
                        const odemeGrup = aktifYetkiler.odeme ? `<button class="btn-kucuk btn-n" onclick="parcaliOdeme(${i}, 'nakit')">Nakit</button><button class="btn-kucuk btn-k" onclick="parcaliOdeme(${i}, 'kart')">Kart</button>` : '';
                        liste.innerHTML += `<div class="adisyon-item"><div>${siparis.urun} - ${siparis.fiyat} TL ${gB}</div><div class="odeme-btn-grup">${odemeGrup}${iptalBtn}</div></div>`;
                    }
                });
            }
            if(!acik) liste.innerHTML = '<div style="color:#888;">AÃ§Ä±k sipariÅŸ yok...</div>';
            document.getElementById('masaToplam').innerText = m.toplam; document.getElementById('masaGuncelTutar').innerText = m.toplam + " TL";
        }

        function parcaliOdeme(i, tur) { const m = getMasa(aktifMasaId); m.siparisler[i].odendi = true; genelCiroEkle(tur, m.siparisler[i].fiyat); m.toplam -= m.siparisler[i].fiyat; masaSifirlaKontrol(); veriyiKaydet(); }

        function tekliUrunIptal(i) {
            const m = getMasa(aktifMasaId); const u = m.siparisler[i];
            if(confirm(`Ä°ptal edilecek. Emin misin?`)) { m.toplam -= u.fiyat; persIptalEkle(aktifPersonel, u.fiyat); persCiroEkle(u.garson, -u.fiyat); m.siparisler.splice(i, 1); masaSifirlaKontrol(); veriyiKaydet(); }
        }

        function hesapKapatMenuAc() {
            if(getMasa(aktifMasaId).toplam === 0) return alert("Masa boÅŸ!");
            document.getElementById('standartAksiyonlar').style.display = 'none'; document.getElementById('gelismisOdemeSecenekleri').style.display = 'flex';
            document.getElementById('odemeTuruSatiri').innerHTML = aktifYetkiler.odeme ? `<button class="btn-ana btn-n" onclick="masayiTamamenKapat('Nakit')">ğŸ’µ Hepsi Nakit</button><button class="btn-ana btn-k" onclick="masayiTamamenKapat('Kart')">ğŸ’³ Hepsi Kart</button>` : '';
            document.getElementById('iptalSatiri').innerHTML = aktifYetkiler.iptal ? `<button class="btn-ana btn-sil" onclick="masayiTamamenKapat('Iptal')">âŒ Hesap Ä°ptal (Sil)</button><button class="btn-ana bg-geri" onclick="hesapKapatMenuKapat()">VazgeÃ§</button>` : `<button class="btn-ana bg-geri" style="width:100%;" onclick="hesapKapatMenuKapat()">VazgeÃ§</button>`;
        }
        function hesapKapatMenuKapat() { document.getElementById('gelismisOdemeSecenekleri').style.display = 'none'; document.getElementById('standartAksiyonlar').style.display = 'flex'; }
        
        function masayiTamamenKapat(yontem) {
            let m = getMasa(aktifMasaId);
            if (yontem === 'Iptal') {
                if(!confirm(`TÃ¼m hesap silinecek!`)) return;
                persIptalEkle(aktifPersonel, m.toplam); 
                if(m.siparisler) m.siparisler.forEach(s => { if(!s.odendi) persCiroEkle(s.garson, -s.fiyat); });
            } else {
                const tur = yontem === 'Nakit' ? 'nakit' : 'kart';
                if(m.siparisler) m.siparisler.forEach(s => { if (!s.odendi) genelCiroEkle(tur, s.fiyat); });
            }
            m.durum = 'bos'; m.siparisler = []; m.toplam = 0; m.acilisZamani = null; veriyiKaydet(); modaliKapat(); 
        }
        function masaSifirlaKontrol() { let m = getMasa(aktifMasaId); if (m.toplam <= 0) { m.durum = 'bos'; m.siparisler = []; m.toplam = 0; m.acilisZamani = null; } }

        function masaTasimaEkraniAc() {
            if (getMasa(aktifMasaId).toplam === 0) return alert("BoÅŸ masa taÅŸÄ±namaz!");
            document.getElementById('anaPanel').style.display = 'none'; document.getElementById('tasimaPaneli').style.display = 'block';
            const c = document.getElementById('tasimaGridContainer'); c.innerHTML = '';
            db.masalar.forEach(m => {
                if (m.id === aktifMasaId) return; 
                const d = document.createElement('div'); d.className = `masa ${m.durum === 'bos' ? 'bos' : 'dolu pasif'}`; d.innerHTML = m.isim;
                if (m.durum === 'bos') d.onclick = () => transferIsleminiYap(m.id); c.appendChild(d);
            });
        }
        function masaTasimaIptal() { document.getElementById('tasimaPaneli').style.display = 'none'; document.getElementById('anaPanel').style.display = 'block'; }
        function transferIsleminiYap(hId) {
            let k = getMasa(aktifMasaId), h = getMasa(hId);
            if(confirm(`TaÅŸÄ±nacak. Emin misin?`)) {
                h.durum = k.durum; h.siparisler = k.siparisler ? JSON.parse(JSON.stringify(k.siparisler)) : []; h.toplam = k.toplam; h.acilisZamani = k.acilisZamani;
                k.durum = 'bos'; k.siparisler = []; k.toplam = 0; k.acilisZamani = null; veriyiKaydet(); modaliKapat(); 
            }
        }

        // --- PERSONEL DÃœZENLEME & SÄ°LME ---
        function personelListesiniCiz() {
            const liste = document.getElementById('personelListesi'); liste.innerHTML = '';
            for (let isim in db.kullanicilar) {
                const isAdmin = db.kullanicilar[isim].rol === 'admin'; 
                const sBtn = !isAdmin ? `<button class="btn-kucuk btn-sil" onclick="personelSil('${isim}')">Sil</button>` : '';
                const dBtn = `<button class="btn-kucuk btn-duzenle" onclick="personelDuzenleAc('${isim}')">âœï¸ DÃ¼zenle</button>`;
                liste.innerHTML += `<div class="sortable-satir"><div>ğŸ‘¤ <b>${isim}</b> ${isAdmin?'(Admin)':''}</div><div style="display:flex; gap:5px;">${dBtn}${sBtn}</div></div>`;
            }
        }

        function personelEkle() {
            const isim = document.getElementById('yeniPersIsim').value.trim(), sifre = document.getElementById('yeniPersSifre').value.trim();
            if(!isim || sifre.length < 4) return alert("HatalÄ± GiriÅŸ!"); if(db.kullanicilar[isim]) return alert("Personel var!");
            
            const yetki_odeme = document.getElementById('y_odeme').checked;
            const yetki_iptal = document.getElementById('y_iptal').checked;
            const yetki_zrapor = document.getElementById('y_zrapor').checked;

            db.kullanicilar[isim] = { sifre: sifre, rol: 'garson', yetki: {odeme: yetki_odeme, iptal: yetki_iptal, zrapor: yetki_zrapor} }; 
            
            document.getElementById('yeniPersIsim').value = ''; document.getElementById('yeniPersSifre').value = ''; 
            document.getElementById('y_odeme').checked = true; document.getElementById('y_iptal').checked = false; document.getElementById('y_zrapor').checked = false;
            veriyiKaydet(); personelListesiniCiz(); alert("Personel Eklendi!");
        }

        function personelDuzenleAc(eskiIsim) {
            duzenlenecekPersonel = eskiIsim;
            document.getElementById('duzenleAdminSifre').value = '';
            document.getElementById('duzenleGuvenlikAdimi').style.display = 'block'; document.getElementById('duzenleFormAdimi').style.display = 'none';
            document.getElementById('personelDuzenleEkrani').style.display = 'flex';
        }

        function duzenleSifreKontrol() {
            if (document.getElementById('duzenleAdminSifre').value === db.kullanicilar['Admin'].sifre) {
                document.getElementById('duzenleGuvenlikAdimi').style.display = 'none'; document.getElementById('duzenleFormAdimi').style.display = 'block';
                document.getElementById('duzenleIsim').value = duzenlenecekPersonel; document.getElementById('duzenleSifre').value = db.kullanicilar[duzenlenecekPersonel].sifre;
                
                const mevYetki = db.kullanicilar[duzenlenecekPersonel].yetki || {odeme: false, iptal: false, zrapor: false};
                document.getElementById('d_odeme').checked = mevYetki.odeme; document.getElementById('d_iptal').checked = mevYetki.iptal; document.getElementById('d_zrapor').checked = mevYetki.zrapor;
            } else { alert("âŒ HatalÄ± Admin Åifresi!"); document.getElementById('duzenleAdminSifre').value = ''; }
        }

        function duzenleKaydet() {
            const eskiIsim = duzenlenecekPersonel; const yeniIsim = document.getElementById('duzenleIsim').value.trim(); const yeniSifre = document.getElementById('duzenleSifre').value.trim();
            if (!yeniIsim) return alert("KullanÄ±cÄ± adÄ± boÅŸ!"); if (yeniSifre.length < 4) return alert("Åifre min 4 hane!");
            if (yeniIsim !== eskiIsim && db.kullanicilar[yeniIsim]) return alert("Bu isimde personel var!");

            const rol = db.kullanicilar[eskiIsim].rol;
            const seciliYetkiler = {odeme: document.getElementById('d_odeme').checked, iptal: document.getElementById('d_iptal').checked, zrapor: document.getElementById('d_zrapor').checked};
            
            if (yeniIsim !== eskiIsim) {
                db.kullanicilar[yeniIsim] = { sifre: yeniSifre, rol: rol, yetki: seciliYetkiler }; delete db.kullanicilar[eskiIsim];
                ['gunluk', 'haftalik', 'aylik'].forEach(d => {
                    if(db.ciro[d].persCiro[eskiIsim] !== undefined) { db.ciro[d].persCiro[yeniIsim] = db.ciro[d].persCiro[eskiIsim]; delete db.ciro[d].persCiro[eskiIsim]; }
                    if(db.ciro[d].persIptal[eskiIsim] !== undefined) { db.ciro[d].persIptal[yeniIsim] = db.ciro[d].persIptal[eskiIsim]; delete db.ciro[d].persIptal[eskiIsim]; }
                });
                if (db.masalar) db.masalar.forEach(m => { if(m.siparisler) m.siparisler.forEach(s => { if(s.garson === eskiIsim) s.garson = yeniIsim; }); });
            } else { db.kullanicilar[eskiIsim].sifre = yeniSifre; db.kullanicilar[eskiIsim].yetki = seciliYetkiler; }

            veriyiKaydet(); personelListesiniCiz(); document.getElementById('personelDuzenleEkrani').style.display = 'none'; alert("GÃ¼ncellendi!");
        }

        function personelSil(isim) { if(confirm(`Silinsin mi?`)) { delete db.kullanicilar[isim]; veriyiKaydet(); personelListesiniCiz(); } }
        
        // ==========================================
        // YENÄ° ZAMANLI Z RAPORU (GEÃ‡MÄ°Å GÃœNLER DAHÄ°L)
        // ==========================================
        function zRaporuCiz(donem) {
            document.querySelectorAll('.sekme-btn-z').forEach(b => b.classList.remove('aktif'));
            document.getElementById('sekme_' + donem).classList.add('aktif');

            const tarihSecici = document.getElementById('gecmisTarihSecici');
            
            if(donem === 'gecmis') {
                tarihSecici.style.display = 'block';
                gecmisRaporGetir(); // Takvimden veriyi getir
                return;
            } else {
                tarihSecici.style.display = 'none';
            }

            const d = db.ciro[donem];
            let baslik = donem === 'gunluk' ? 'BugÃ¼n' : donem === 'haftalik' ? 'Bu Hafta' : 'Bu Ay';
            raporEkranaBas(d, baslik);
        }

        function gecmisRaporGetir() {
            const secilenTarih = document.getElementById('gecmisTarih').value; // YYYY-MM-DD
            if(!secilenTarih) {
                document.getElementById('zRaporuIcerikAlani').innerHTML = '<div style="text-align:center; padding:20px; color:#888;">LÃ¼tfen yukarÄ±dan bir tarih seÃ§in.</div>';
                return;
            }

            if(secilenTarih === getGun()) {
                raporEkranaBas(db.ciro.gunluk, `BugÃ¼n (${secilenTarih})`);
            } else if (db.gecmisCiro && db.gecmisCiro[secilenTarih]) {
                raporEkranaBas(db.gecmisCiro[secilenTarih], secilenTarih);
            } else {
                document.getElementById('zRaporuIcerikAlani').innerHTML = `<div style="text-align:center; padding:20px; color:#f44336; font-weight:bold;">${secilenTarih} tarihine ait veri bulunamadÄ±!</div>`;
            }
        }

        function raporEkranaBas(d, baslik) {
            if(!d) return;
            document.getElementById('zRaporuIcerikAlani').innerHTML = `
                <div class="rapor-kutu">
                    <div class="rapor-baslik">Kasa Ã–zeti (${baslik})</div>
                    <div class="sortable-satir"><span>ğŸ’µ Nakit Tahsilat:</span> <strong style="color:#4CAF50;">${d.nakit} TL</strong></div>
                    <div class="sortable-satir"><span>ğŸ’³ Kredi KartÄ± Tahsilat:</span> <strong style="color:#2196F3;">${d.kart} TL</strong></div>
                    <div class="sortable-satir" style="border: 1px solid #ff9800; background: #fff8e1;"><span>ğŸ’° TOPLAM CÄ°RO:</span> <strong style="color:#ff9800; font-size:16px;">${d.nakit + d.kart} TL</strong></div>
                    <div class="sortable-satir" style="margin-top:10px; border-color:#f44336;"><span>âŒ Toplam Ä°ptal Edilen:</span> <strong style="color:#f44336;">${d.iptal} TL</strong></div>
                </div>
            `;

            let persHtml = `<div class="rapor-kutu"><div class="rapor-baslik">Personel PerformansÄ±</div>`;
            let persVarMi = false;
            const pCiro = d.persCiro || {}; const pIptal = d.persIptal || {};

            for (let kisi in pCiro) {
                persVarMi = true;
                persHtml += `<div class="sortable-satir"><div style="font-weight:bold;">ğŸ‘¤ ${kisi}</div><div style="text-align:right;">
                <div style="color:#2e7d32; font-size:13px;">Ciro (Onaylanan): <b>${pCiro[kisi]} TL</b></div>
                <div style="color:#d32f2f; font-size:13px;">Ä°ptal/Sorumlu: <b>${pIptal[kisi] || 0} TL</b></div></div></div>`;
            }
            if(!persVarMi) persHtml += `<div style="font-size:13px; color:#888;">HenÃ¼z iÅŸlem yapÄ±lmamÄ±ÅŸ.</div>`;
            persHtml += `</div>`;

            document.getElementById('zRaporuIcerikAlani').innerHTML += persHtml;
        }

        function zRaporuAc() {
            ciroZamanKontrolu(); 
            document.getElementById('zRaporuEkrani').style.display = 'flex';
            zRaporuCiz('gunluk'); 
        }

    </script>
</body>
</html>